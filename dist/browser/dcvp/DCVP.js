"use strict";var _classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var uuidv4=require("uuid/v4"),_=require("lodash"),_require=require("@identity.com/credential-commons"),UCA=_require.UCA,DCVPStep=function(){function a(b,c,d,e){(0,_classCallCheck3.default)(this,a),this.status="pending",this.identifier=b,this.hasPayload=c||!1,this.payload=this.hasPayload?null:void 0,this.ucas=d,this.dependsOn=e}return(0,_createClass3.default)(a,null,[{key:"fromJSON",value:function(b){return new a(b.identifier,b.hasPayload,b.ucas,b.dependsOn)}}]),a}(),hasDependsPending=function(a,b){var c=!1;if(!_.isEmpty(a.dependsOn))for(var d,e=function(d){var e=_.find(b,function(b){return b.identifier===a.dependsOn[d]});return"pending"===e.status&&(c=!0),"break"},f=0;f<a.dependsOn.length&&(d=e(f),"break"!==d);f+=1);return c},DCVP=function(){function a(b,c){(0,_classCallCheck3.default)(this,a),this.id=uuidv4(),this.status="started",this.crId=c,this.credentialIdentifier=b.credentialIdentifier,this.description=b.description,this.createdOn=new Date().getTime(),this.steps=_.map(b.steps,function(a){return DCVPStep.fromJSON(a)})}return(0,_createClass3.default)(a,[{key:"getNextSteps",value:function(){var a=this,b=_.filter(this.steps,function(b){return"pending"===b.status&&!hasDependsPending(b,a.steps)});return b}},{key:"addUcaValues",value:function(a){var b=this,c=this.getNextSteps();_.each(a,function(a){b.steps=_.map(b.steps,function(b){var d;if(-1<_.findIndex(c,function(a){return a.identifier===b.identifier})){for(var e=_.map(b.ucas,function(b){var c;if(b.uca===a.uca)try{var d=new UCA(a.uca,a.value);c=_.merge({},{uca:a.uca,value:d.value,status:"filled"})}catch(b){c=_.merge({},{uca:a.uca,value:a.value,status:"invalid_uca_value"})}else c=_.merge({},b);return c}),f=!0,g=0;g<e.length&&(f="filled"===e[g].status,!!f);g+=1);d=_.merge({},b,{status:f?"filled":b.status,ucas:e})}else d=_.merge({},b);return d})})}}]),a}();module.exports=DCVP;